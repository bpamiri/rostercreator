<cfcomponent extends="controller">
	
	<cffunction name="init"> 
	
		<cfset filters(through="isLoggedIn")>
	
	</cffunction>	
	
	<cffunction name="add">
	
		<cfset roster = model("roster").New()>
	
	</cffunction>
	
	<cffunction name="process">
			
		<cfset roster = model("roster").new(params.roster)>
		<cfset roster.userid = session.user.id>
		<cfset roster.save()>
		
		<cfif roster.hasErrors()>
			<cfset RenderPage(action="upload")>
		<cfelse>
			<cffile action="read" file="#roster.rosterFile#" variable="csvfile">

			<cfloop index="line" list="#csvfile#" delimiters="#chr(10)##chr(13)#">
				<cfif listgetAt('#line#',1) neq '"ID Number"'>
					<cfset member=model("member").new()>
					<cfset member.rosterid = roster.id>
					<cfset member.bid = Replace(listgetAt(line,1),'"','','all')>
					<cfset member.FullName = Replace(listgetAt(line,2),'"','','all')>
					<cfset member.Title = Replace(listgetAt(line,3),'"','','all')>
					<cfset member.FirstName = Replace(listgetAt(line,4),'"','','all')>
					<cfset member.MiddleName = Replace(listgetAt(line,5),'"','','all')>
					<cfset member.LastName = Replace(listgetAt(line,6),'"','','all')>
					<cfset member.Suffix = Replace(listgetAt(line,7),'"','','all')>
					<cfset member.AddressLine1 = Replace(listgetAt(line,8),'"','','all')>
					<cfset member.AddressLine2 = Replace(listgetAt(line,9),'"','','all')>
					<cfset member.City = Replace(listgetAt(line,10),'"','','all')>
					<cfset member.State = Replace(listgetAt(line,11),'"','','all')>
					<cfset member.ZipCode = Replace(listgetAt(line,12),'"','','all')>
					<cfset member.HouseholdID = Replace(listgetAt(line,13),'"','','all')>
					<cfset member.HouseholdName = Replace(listgetAt(line,14),'"','','all')>
					<cfset member.HeadofHousehold = Replace(listgetAt(line,15),'"','','all')>
					<cfset member.BadMailAddress = Replace(listgetAt(line,16),'"','','all')>
					<cfset member.AcceptMail = Replace(listgetAt(line,17),'"','','all')>
					<cfset member.PhoneHome = Replace(listgetAt(line,18),'"','','all')>
					<cfset member.PhoneWork = Replace(listgetAt(line,19),'"','','all')>
					<cfset member.PhoneCell = Replace(listgetAt(line,20),'"','','all')>
					<cfset member.RequestNoPhone = Replace(listgetAt(line,21),'"','','all')>
					<cfset member.Email = Replace(listgetAt(line,22),'"','','all')>
					<cfset member.RightsStatus = Replace(listgetAt(line,23),'"','','all')>
					<cfset member.AgeGroup = Replace(listgetAt(line,24),'"','','all')>
					<cfset member.Ethnicity = Replace(listgetAt(line,25),'"','','all')>
					<cfset member.Race = Replace(listgetAt(line,26),'"','','all')>
					<cfset member.Gender = Replace(listgetAt(line,27),'"','','all')>
					<cfset member.Sector = Replace(listgetAt(line,28),'"','','all')>
					<cfset member.save()>
				</cfif>			
			</cfloop>
			
			<cfset roster.membercount = model("member").count(where="rosterid=#roster.id#")>
			<cfset roster.hohcount = model("member").count(where="rosterid=#roster.id# AND HeadofHousehold='yes'")>
			<cfset roster.adultcount = model("member").count(where="rosterid=#roster.id# AND agegroup='Adult'")>
			<cfset roster.youthcount = model("member").count(where="rosterid=#roster.id# AND agegroup='Youth'")>
			<cfset roster.jryouthcount = model("member").count(where="rosterid=#roster.id# AND agegroup='Jr Youth'")>
			<cfset roster.childcount = model("member").count(where="rosterid=#roster.id# AND agegroup='Child'")>
			<cfset roster.save()>
			
			<cfset flashInsert(success="You've successfully uploaded a roser file.")>
			<cfset redirectTo(action="index")>		
		</cfif>
	
	</cffunction>
	
	<cffunction name="index">
	
		<cfset rosters = model("roster").findAll(where="userid = #session.user.id#")>
		<cfif rosters.recordcount eq 0>
			<cfset flashInsert(error="There are no roster files to display. Use the Upload Roster link to upload a new roster.")>
		</cfif>	
	</cffunction>
	
	<cffunction name="delete">
		
		<cfset roster = model("roster").findOne(where="id=#params.key# AND userid=#session.user.id#")>

		<cfif IsObject(roster)>
			<cfset roster.deleteAllMembers()>
			<cfset roster.delete()>

			<cfset flashInsert(success="You've successfully delete the roster and associated member records.")>
		<cfelse>
			<cfset flashInsert(error="Unable to delete the selected roster file. Please try again later.")>
		</cfif>	

		<cfset redirectTo(action="index")>		
	
	</cffunction>

	<cffunction name="edit">
		
		<cfset roster = model("roster").findOne(where="id=#params.key# AND userid=#session.user.id#")>

		<cfif not IsObject(roster)>
			<cfset flashInsert(error="Unable to find the specified roster file. Please try again later.")>
			<cfset redirectTo(action="index")>		
		</cfif>	
	
	</cffunction>
	
	<cffunction name="pdf">
	
		<cfset roster = model("roster").findOne(where="id=#params.key# AND userid=#session.user.id#")>

		<cfif IsObject(roster)>
			<cfset hoh = model("member").findAll(where="rosterid=#roster.id# AND headofhousehold='yes'",orderby="lastname")>
			<cfset renderPartial(partial="roster1")>
		<cfelse>
			<cfset flashInsert(error="Unable to find the specified roster file. Please try again later.")>
			<cfset redirectTo(action="index")>		
		</cfif>	

	</cffunction>

</cfcomponent>